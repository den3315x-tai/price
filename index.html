<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查詢開價</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
        }
        /* 表格樣式調整 for mobile */
        @media (max-width: 767px) {
            .table-responsive thead {
                display: none;
            }
            .table-responsive, .table-responsive tbody, .table-responsive tr, .table-responsive td {
                display: block;
                width: 100%;
            }
            .table-responsive tr {
                margin-bottom: 1rem;
                background-color: #fff;
                border-radius: 0.75rem;
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                border: 1px solid #e5e7eb;
            }
            .table-responsive td {
                text-align: right;
                padding-left: 50%;
                position: relative;
            }
            .table-responsive td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 50%;
                padding-left: 1.5rem;
                text-align: left;
                font-weight: 600;
                color: #4b5563;
                text-transform: uppercase;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto p-8 bg-white rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6" id="mainTitle">查詢開價</h1>

        <!-- 認證區域 -->
        <div id="authSection" class="flex flex-col items-center space-y-4">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4" id="authTitle">請先登入</h2>
            <div id="loginForm" class="w-full max-w-sm">
                <input type="email" id="emailInput" placeholder="電子郵件" class="w-full p-3 mb-4 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="passwordInput" placeholder="密碼" class="w-full p-3 mb-4 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="loginBtn" class="w-full p-3 text-white font-bold bg-indigo-600 rounded-md shadow-lg hover:bg-indigo-700 transition-colors">登入</button>
                <p class="text-center text-gray-600 mt-4">
                    還沒有帳號？<a href="#" id="showRegister" class="text-indigo-600 hover:text-indigo-800 font-semibold">註冊</a>
                </p>
            </div>
            <div id="registerForm" class="w-full max-w-sm hidden">
                <input type="email" id="registerEmailInput" placeholder="電子郵件" class="w-full p-3 mb-4 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="registerPasswordInput" placeholder="密碼" class="w-full p-3 mb-4 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="registerBtn" class="w-full p-3 text-white font-bold bg-green-600 rounded-md shadow-lg hover:bg-green-700 transition-colors">註冊</button>
                <p class="text-center text-gray-600 mt-4">
                    已經有帳號？<a href="#" id="showLogin" class="text-indigo-600 hover:text-indigo-800 font-semibold">登入</a>
                </p>
            </div>
            <div id="authError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md w-full" role="alert">
                <p id="authErrorMessage" class="font-bold"></p>
            </div>
        </div>

        <!-- 內容區塊 (預設隱藏) -->
        <div id="contentSection" class="hidden">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
                <span id="welcomeMessage" class="text-gray-600 mb-2 sm:mb-0"></span>
                <button id="logoutBtn" class="p-2 px-4 text-sm text-white font-semibold bg-red-500 rounded-full hover:bg-red-600 transition-colors">登出</button>
            </div>
            <div class="flex flex-col items-center space-y-4">
                <!-- 搜尋文字方塊 -->
                <input type="text" id="carnumSearchInput" placeholder="輸入車號關鍵字..." class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                
                <!-- 篩選下拉式選單 -->
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full justify-center mt-4">
                    <select id="brandSelect" class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">請選擇品牌</option>
                    </select>
                    <select id="typeSelect" class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" disabled>
                        <option value="">請選擇車型</option>
                    </select>
                </div>

                <div id="loadingIndicator" class="hidden text-center text-indigo-600 font-semibold">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>正在載入...</span>
                    </div>
                </div>

                <div id="errorBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md w-full" role="alert">
                    <p id="errorMessage" class="font-bold"></p>
                </div>
            </div>

            <div id="tableContainer" class="mt-8 overflow-x-auto">
                <!-- XML 表格將動態生成於此 -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAxWxCRvS0hBKsxqV0Zbr2WZbRYHomxWtY",
            authDomain: "car-price-viewer.firebaseapp.com",
            projectId: "car-price-viewer",
            storageBucket: "car-price-viewer.appspot.com",
            messagingSenderId: "577380544164",
            appId: "1:577380544164:web:278cfd2b43059168ee8031",
            measurementId: "G-4T0499BQ75"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI elements
        const authSection = document.getElementById('authSection');
        const contentSection = document.getElementById('contentSection');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const showRegisterLink = document.getElementById('showRegister');
        const showLoginLink = document.getElementById('showLogin');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const registerEmailInput = document.getElementById('registerEmailInput');
        const registerPasswordInput = document.getElementById('registerPasswordInput');
        const authErrorBox = document.getElementById('authError');
        const authErrorMessage = document.getElementById('authErrorMessage');
        const welcomeMessage = document.getElementById('welcomeMessage');

        // Functions to show/hide sections
        function showContent(user) {
            authSection.classList.add('hidden');
            contentSection.classList.remove('hidden');
            welcomeMessage.textContent = `歡迎回來，${user.email || '訪客'}！`;
            // Call the function to load and display data
            handleUrlLoad();
        }

        function showAuth() {
            authSection.classList.remove('hidden');
            contentSection.classList.add('hidden');
            hideAuthError();
        }

        function showAuthError(message) {
            authErrorMessage.textContent = message;
            authErrorBox.classList.remove('hidden');
        }

        function hideAuthError() {
            authErrorBox.classList.add('hidden');
        }

        // Event listeners for auth UI
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            hideAuthError();
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            hideAuthError();
        });

        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showAuthError("請輸入電子郵件和密碼。");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showAuthError("登入失敗：" + error.message);
            }
        });

        registerBtn.addEventListener('click', async () => {
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            if (!email || !password) {
                showAuthError("請輸入電子郵件和密碼。");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert("註冊成功！請登入。");
                showLoginLink.click();
            } catch (error) {
                showAuthError("註冊失敗：" + error.message);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                showContent(user);
            } else {
                showAuth();
            }
        });

        // =========================================================
        // The rest of your existing code
        // =========================================================
        const carnumSearchInput = document.getElementById('carnumSearchInput');
        const brandSelect = document.getElementById('brandSelect');
        const typeSelect = document.getElementById('typeSelect');
        const tableContainer = document.getElementById('tableContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        const xmlUrl = "https://raw.githubusercontent.com/den3315x-tai/price/refs/heads/main/CAR-P.xml";
        let allCarData = []; 

        const fieldNames = {
            carnum: '車號',
            brand: '品牌',
            type: '車型',
            yaer: '年份',
            cc: '排氣量',
            c: '顏色',
            op: '售價'
        };

        brandSelect.addEventListener('change', () => {
            populateTypeDropdown(brandSelect.value);
            updateTableDisplay();
        });

        typeSelect.addEventListener('change', () => {
            updateTableDisplay();
        });

        carnumSearchInput.addEventListener('input', () => {
            updateTableDisplay();
        });

        async function handleUrlLoad() {
            showLoading();
            hideError();
            clearTable();
            
            try {
                const response = await fetch(xmlUrl);
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                }
                const xmlString = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");

                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error("無效的 XML 檔案格式。");
                }

                allCarData = parseXml(xmlDoc);

                if (allCarData.length > 0) {
                    populateBrandDropdown(allCarData);
                    updateTableDisplay();
                } else {
                    showError("XML 檔案中未找到可轉換為表格的資料。");
                }

            } catch (error) {
                showError("處理檔案時發生錯誤：" + error.message);
            } finally {
                hideLoading();
            }
        }

        function parseXml(xmlDoc) {
            const records = [];
            const items = xmlDoc.getElementsByTagName('CAR-P');
            if (items.length === 0) {
                return records;
            }
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const record = {};
                const fields = ['carnum', 'brand', 'type', 'yaer', 'cc', 'c', 'op'];
                fields.forEach(field => {
                    const childElement = item.getElementsByTagName(field)[0];
                    record[field] = (childElement && childElement.textContent !== null) ? childElement.textContent : '';
                });
                if (Object.keys(record).length > 0) {
                    records.push(record);
                }
            }
            return records;
        }

        function populateBrandDropdown(data) {
            const brands = [...new Set(data.map(item => item.brand))].sort();
            brandSelect.innerHTML = '<option value="">請選擇品牌</option>';
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });
            brandSelect.disabled = false;
            populateTypeDropdown('');
        }

        function populateTypeDropdown(selectedBrand) {
            typeSelect.innerHTML = '<option value="">請選擇車型</option>';
            typeSelect.disabled = true;

            if (selectedBrand) {
                const filteredData = allCarData.filter(item => item.brand === selectedBrand);
                const types = [...new Set(filteredData.map(item => item.type))].sort();
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });
                typeSelect.disabled = false;
            }
        }

        function updateTableDisplay() {
            const selectedBrand = brandSelect.value;
            const selectedType = typeSelect.value;
            const carnumSearchTerm = carnumSearchInput.value.toLowerCase();
            
            let filteredData = allCarData;

            if (selectedBrand) {
                filteredData = filteredData.filter(item => item.brand === selectedBrand);
            }
            if (selectedType) {
                filteredData = filteredData.filter(item => item.type === selectedType);
            }
            if (carnumSearchTerm) {
                filteredData = filteredData.filter(item => item.carnum.toLowerCase().includes(carnumSearchTerm));
            }

            createTable(filteredData);
        }

        function createTable(data) {
            if (data.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500">沒有符合條件的資料。</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = "min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg table-responsive";
            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);

            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = Object.keys(data[0]);

            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.scope = "col";
                th.className = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50";
                th.textContent = fieldNames[headerText] || headerText;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            data.forEach(rowData => {
                const row = tbody.insertRow();
                headers.forEach(header => {
                    const cell = row.insertCell();
                    cell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-800";
                    cell.textContent = rowData[header];
                    cell.setAttribute('data-label', fieldNames[header] || header);
                });
            });
        }

        function clearTable() {
            tableContainer.innerHTML = '';
        }

        function showLoading() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }
    </script>
</body>
</html>
